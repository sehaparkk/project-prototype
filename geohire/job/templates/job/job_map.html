{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Job Map</title>
    <link rel="stylesheet" type="text/css" href="{% static 'css/main.css' %}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        #map { height: 500px; }
    </style>
</head>
<body>
    <h1>Job Map</h1>

    <form id="filter-form">
        <label for="radius">Radius (in miles):</label>
        <input type="number" id="radius" name="radius" value="10">
        <button type="button" onclick="filterJobs()">Filter</button>
    </form>

    <div id="map"></div>

    <script>
        var map = L.map('map').setView([0, 0], 2);
        var userMarker;
        var circle;

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        var jobData = JSON.parse('{{ job_data|safe }}');
        var jobMarkers = [];

        function showJobs(jobs) {
            jobMarkers.forEach(function(marker) {
                map.removeLayer(marker);
            });
            jobMarkers = [];

            jobs.forEach(function(job) {
                var marker = L.marker([job.lat, job.lng]).addTo(map);
                marker.bindPopup('<b>' + job.title + '</b><br><a href="' + job.url + '">View Job</a>');
                jobMarkers.push(marker);
            });
        }

        showJobs(jobData);

        function filterJobs() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    var lat = position.coords.latitude;
                    var lng = position.coords.longitude;
                    var radius = document.getElementById('radius').value;

                    if (userMarker) {
                        map.removeLayer(userMarker);
                    }
                    if (circle) {
                        map.removeLayer(circle);
                    }

                    userMarker = L.marker([lat, lng]).addTo(map);
                    userMarker.bindPopup('Your Location').openPopup();
                    map.setView([lat, lng], 10);

                    circle = L.circle([lat, lng], {
                        radius: radius * 1609.34 // miles to meters
                    }).addTo(map);

                    var filteredJobs = jobData.filter(function(job) {
                        var jobLatLng = L.latLng(job.lat, job.lng);
                        var userLatLng = L.latLng(lat, lng);
                        return userLatLng.distanceTo(jobLatLng) <= radius * 1609.34;
                    });

                    showJobs(filteredJobs);
                });
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }
    </script>
</body>
</html>
